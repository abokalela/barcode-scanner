<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
<title>ماسح الباركود</title>
<style>
  body { font-family: Arial, sans-serif; text-align:center; margin:0; padding:0; background:#f5f5f5; }
  #video-container { position: relative; width:100%; max-width:720px; margin:20px auto; }
  #video { width:100%; height:auto; border-radius:12px; display:block; }
  #scanner-line { position:absolute; left:0; width:100%; height:3px; background:rgba(255,0,0,0.85); pointer-events:none;
    animation: scanline 1600ms linear infinite; }
  @keyframes scanline {
    0% { top: 5%; }
    50% { top: 85%; }
    100% { top: 5%; }
  }
  #result { margin-top:14px; font-size:1.05rem; color:#054a7a; min-height:1.2em; }
  .controls { margin-top:14px; display:flex; gap:10px; justify-content:center; }
  button { padding:10px 16px; font-size:16px; border:none; border-radius:8px; background:#0b6fb2; color:#fff; cursor:pointer; }
  button.secondary { background:transparent; color:#0b6fb2; border:1px solid #cde8fb; }
</style>
</head>
<body>
  <h2>ماسح الباركود</h2>

  <div id="video-container">
    <video id="video" autoplay playsinline></video>
    <div id="scanner-line"></div>
  </div>

  <div id="result">جاري المسح... (أقرب الكاميرا إلى الباركود)</div>

  <div class="controls">
    <button id="stopBtn">إيقاف المسح</button>
    <button id="rescanBtn" class="secondary">إعادة المسح</button>
  </div>

  <!-- ZXing UMD -->
  <script src="https://unpkg.com/@zxing/library@0.19.1/umd/index.min.js"></script>
  <script>
    const SCANNER_ORIGIN = "https://abokalela.github.io"; // ضع هنا دومين صفحة الماسح (بدون مسار)
    const codeReader = new ZXing.BrowserBarcodeReader();
    const video = document.getElementById('video');
    const resultDiv = document.getElementById('result');
    const stopBtn = document.getElementById('stopBtn');
    const rescanBtn = document.getElementById('rescanBtn');

    let activeStream = null;
    let decoding = false;

    async function startScan() {
      try {
        resultDiv.textContent = "جاري المسح...";
        const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
        activeStream = stream;
        video.srcObject = stream;
        video.play().catch(()=>{});
        decoding = true;

        codeReader.decodeFromVideoDevice(null, video, (result, err) => {
          if (!decoding) return;
          if (result) {
            const codeText = result.text;
            resultDiv.textContent = "تم العثور على الكود: " + codeText;
            // أرسل النتيجة إلى النافذة الأصل (opener)
            try {
              // إرسال كائن يحتوي barcode لمرونة التحقق
              if (window.opener && !window.opener.closed) {
                // استخدم SCANNER_ORIGIN في بيئة الإنتاج. أثناء التجربة يمكن استخدام "*"
                window.opener.postMessage({ barcode: codeText }, "*");
              }
            } catch (e) {
              console.warn("postMessage failed:", e);
            }
            stopScan();
          }
          if (err && !(err instanceof ZXing.NotFoundException)) {
            console.error(err);
          }
        });
      } catch (e) {
        resultDiv.textContent = "خطأ في الوصول إلى الكاميرا: " + (e.message || e);
        console.error(e);
      }
    }

    function stopScan() {
      decoding = false;
      codeReader.reset(); // stops internal decoding
      if (activeStream) {
        activeStream.getTracks().forEach(t => t.stop());
        activeStream = null;
      }
      resultDiv.textContent += "  [تم الإيقاف]";
    }

    stopBtn.addEventListener('click', () => stopScan());
    rescanBtn.addEventListener('click', () => {
      stopScan();
      setTimeout(() => startScan(), 300);
    });

    // ابدأ المسح فور تحميل الصفحة
    startScan();
  </script>
</body>
</html>
