<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ماسح الباركود</title>

<style>
body {
  margin: 0;
  padding: 0;
  font-family: "Segoe UI", sans-serif;
  background: #000;
  color: #fff;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  height: 100vh;
  overflow: hidden;
}
video {
  width: 100%;
  height: auto;
  max-height: 90vh;
  border-radius: 12px;
  object-fit: cover;
}
#overlay {
  position: absolute;
  top: 0; left: 0; right: 0; bottom: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  pointer-events: none;
}
.frame {
  position: relative;
  width: 260px;
  height: 260px;
  border: 3px solid rgba(0, 255, 0, 0.6);
  border-radius: 12px;
  box-shadow: 0 0 25px rgba(0,255,0,0.4);
  overflow: hidden;
}
.laser {
  position: absolute;
  width: 100%;
  height: 3px;
  background: rgba(255, 0, 0, 0.8);
  box-shadow: 0 0 15px red;
  animation: scan 2s linear infinite;
}
@keyframes scan {
  0% { top: 0; }
  100% { top: calc(100% - 3px); }
}
button {
  margin-top: 10px;
  padding: 10px 20px;
  border: none;
  border-radius: 8px;
  background: #0b6fb2;
  color: #fff;
  font-size: 16px;
  font-weight: bold;
  z-index: 10;
}
</style>
</head>

<body>

<video id="preview" autoplay playsinline></video>

<div id="overlay">
  <div class="frame">
    <div class="laser"></div>
  </div>
</div>

<button id="closeBtn">إغلاق</button>

<script src="https://unpkg.com/@zxing/library@latest"></script>

<script>
const video = document.getElementById("preview");
const codeReader = new ZXing.BrowserMultiFormatReader();

const constraints = {
  video: {
    facingMode: { ideal: "environment" },
    width: { ideal: 1920 },
    height: { ideal: 1080 }
  }
};

navigator.mediaDevices.getUserMedia(constraints).then(stream => {
  video.srcObject = stream;
  enhancedScan();
}).catch(err => console.log(err));

function sendResult(code) {
  window.opener?.postMessage({ barcode: code }, '*');
  window.close();
}

/* ============================
   ماسح محسن (ZXing + تحسين صورة)
   ============================ */
function enhancedScan() {
  codeReader.decodeFromVideoDevice(null, "preview", (result, err) => {
    if (result) {
      sendResult(result.text);
      return;
    }
  });

  // نبدأ عملية تحسين الصورة كل 400ms
  setInterval(() => {
    tryEnhancedFrame();
  }, 400);
}

/* ============================
   التقاط صورة وتحسينها وقراءتها
   ============================ */
function tryEnhancedFrame() {
  const canvas = document.createElement("canvas");
  const ctx = canvas.getContext("2d");

  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;

  ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

  let imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
  let data = imageData.data;

  // زيادة التباين وتحويل الأبيض/الأسود (Threshold)
  for (let i = 0; i < data.length; i += 4) {
    let v = (data[i] + data[i+1] + data[i+2]) / 3;
    let bw = v < 130 ? 0 : 255;
    data[i] = data[i+1] = data[i+2] = bw;
  }

  ctx.putImageData(imageData, 0, 0);

  // محاولة قراءة الكود بعد التحسين
  const luminanceSource = new ZXing.HTMLCanvasElementLuminanceSource(canvas);
  const bitmap = new ZXing.BinaryBitmap(new ZXing.GlobalHistogramBinarizer(luminanceSource));

  try {
    const result = codeReader.decodeBitmap(bitmap);
    if (result && result.text) {
      sendResult(result.text);
    }
  } catch (e) {
    // تجاهل – المحاولة القادمة ستعمل
  }
}

closeBtn.onclick = () => window.close();
</script>

</body>
</html>
